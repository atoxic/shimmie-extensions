
function PhotoNoteContainer(element,config)
{var props={element:element,dragresize:null,notes:new Array(),editing:false};for(var p in props)
{this[p]=(!config||typeof config[p]=='undefined')?props[p]:config[p];}};PhotoNoteContainer.prototype.DeleteNote=function(note)
{note.UnSelect();this.element.removeChild(note.gui.ElementRect);this.element.removeChild(note.gui.ElementNote);this.notes.remove(note);}
PhotoNoteContainer.prototype.AddNote=function(note)
{if(!this.editing)
{this.notes[this.notes.length]=note;note.container=this;this.element.appendChild(note.gui.ElementRect);this.element.appendChild(note.gui.ElementNote);}};PhotoNoteContainer.prototype.HideAllNoteTexts=function()
{for(var i=0;i<this.notes.length;i++)
this.notes[i].HideNoteText();};PhotoNoteContainer.prototype.DisableAllNotes=function()
{for(var i=0;i<this.notes.length;i++)
this.notes[i].DisableNote();};PhotoNoteContainer.prototype.HideAllNotes=function()
{for(var i=0;i<this.notes.length;i++)
this.notes[i].HideNote();};PhotoNoteContainer.prototype.ShowAllNotes=function()
{for(var i=0;i<this.notes.length;i++)
this.notes[i].ShowNote();};PhotoNoteContainer.prototype.EnableAllNotes=function()
{for(var i=0;i<this.notes.length;i++)
this.notes[i].EnableNote();};function PhotoNote(text,id,rect,permission)
{var props={text:text,id:id,rect:rect,selected:false,container:null,dragresize:null,oldRect:null,YOffset:10,XOffset:0,onsave:null,ondelete:null,onhistory:null,gui:null,permission:permission};for(var p in props)
{this[p]=props[p];}
this.CreateElements();}
PhotoNote.prototype.Select=function()
{if(!this.container.editing)
{this.ShowNoteText();this.dragresize.select(this.gui.ElementRect);this.selected=true;this.SetEditable(true);}}
PhotoNote.prototype.UnSelect=function()
{this.dragresize.deselect(false);this.selected=false;this.SetEditable(false);this.HideNoteText();}
PhotoNote.prototype.Save=function()
{this.oldRect=null;var t=document.createTextNode(this.gui.TextBox.value);while(this.gui.TextTitle.hasChildNodes())
{this.gui.TextTitle.removeChild(this.gui.TextTitle.lastChild);}
this.gui.TextTitle.appendChild(t);this.text=this.gui.TextBox.value;this.UnSelect();}
PhotoNote.prototype.Cancel=function()
{if(this.id<0)
{this.container.DeleteNote(this)}
else
{if(this.oldRect!=null)
{this.rect=this.oldRect;}
this.oldRect=null;this.gui.TextBox.value=this.text;this.PositionNote();this.UnSelect();}}
PhotoNote.prototype.ShowNoteText=function()
{if(!this.container.editing)
{this.container.HideAllNoteTexts();this.container.DisableAllNotes();this.EnableNote();this.gui.ElementRect.style.border='1px solid #D4D82D';this.gui.ElementRect.style.margin='0';this.gui.ElementNote.style.display='block';}}
PhotoNote.prototype.DisableNote=function()
{this.dragresize.enabled=false;}
PhotoNote.prototype.EnableNote=function()
{this.dragresize.enabled=true;}
PhotoNote.prototype.HideNoteText=function()
{this.gui.ElementRect.style.border='0px solid #D4D82D';this.gui.ElementRect.style.margin='1px';this.gui.ElementNote.style.display='none';}
PhotoNote.prototype.HideNote=function()
{this.gui.ElementRect.style.display='none';this.gui.ElementNote.style.display='none';}
PhotoNote.prototype.ShowNote=function()
{this.gui.ElementRect.style.display='block';this.gui.ElementNote.style.display='none';}
PhotoNote.prototype.SetEditable=function(editable)
{this.container.editing=editable;if(editable)
{this.gui.TextTitle.style.display='none';this.gui.EditArea.style.display='block';if(this.id<=0)
this.gui.DeleteButton.style.display='none';else
this.gui.DeleteButton.style.display='inline';this.HighlightTextbox();}
else
{this.gui.TextTitle.style.display='block';this.gui.EditArea.style.display='none';}}
PhotoNote.prototype.HighlightTextbox=function()
{if(this.gui.EditArea.style.display=='block')
{var textfield=this.gui.TextBox;setTimeout(function(){try
{textfield.focus();textfield.select();}
catch(e){}},200);}}
PhotoNote.prototype.CreateElements=function()
{this.gui=new PhotoNoteGUI();var newArea=document.createElement('div');this.dragresize=new DragResize('dragresize',{allowBlur:false});newArea.className='fn-area';newArea.id='fn-area-new';var newAreaBlack=document.createElement('div');newAreaBlack.className='fn-area-blackborder';var newAreaWhite=document.createElement('div');newAreaWhite.className='fn-area-whiteborder';var currentNote=this;var newAreaInner=document.createElement('div');newAreaInner.className='fn-area-inner';newAreaWhite.appendChild(newAreaInner);addEvent(newAreaInner,'mouseover',function(){currentNote.ShowNoteText();});addEvent(newAreaInner,'mouseout',function(){if(!currentNote.selected)
{setTimeout(function(){currentNote.HideNoteText();},250);}});addEvent(newAreaInner,'mousedown',function(){if(!currentNote.selected)
{currentNote.Select();}});newAreaBlack.appendChild(newAreaWhite);newArea.appendChild(newAreaBlack);var noteArea=document.createElement('div');noteArea.className='fn-note';var titleArea=document.createElement('textarea');titleArea.setAttribute("readonly","readonly");titleArea.className='fn-note-text';var t=document.createTextNode(this.text);titleArea.appendChild(t);noteArea.appendChild(titleArea);var editArea=document.createElement('div');editArea.className='fn-note-edit';var editAreaText=document.createElement('div');editAreaText.className='fn-note-edit-text';var newTextbox=document.createElement('textarea');newTextbox.value=this.text;editAreaText.appendChild(newTextbox);editArea.appendChild(editAreaText);var buttonsDiv=document.createElement('div');var newButtonOK=document.createElement('input');newButtonOK.type='button';newButtonOK.className='Butt';newButtonOK.value='SAVE';newButtonOK.onclick=function(){if(currentNote.onsave)
{var res=currentNote.onsave(currentNote);if(res>0)
{currentNote.id=res;currentNote.Save();}
else
{alert("error saving note");currentNote.Cancel();}}
else
{alert("onsave must be implemented in order to *actually* save");currentNote.Cancel();}};if(this.permission>=1)
buttonsDiv.appendChild(newButtonOK);var newButtonCancel=document.createElement('input');newButtonCancel.type='button';newButtonCancel.className='CancelButt';newButtonCancel.value='CANCEL';newButtonCancel.onclick=function(){currentNote.Cancel();};buttonsDiv.appendChild(newButtonCancel);var newButtonHistory=document.createElement('input');newButtonHistory.type='button';newButtonHistory.className='CancelButt';newButtonHistory.value='HISTORY';newButtonHistory.onclick=function(){if(currentNote.onhistory)
{currentNote.onhistory(currentNote);}};buttonsDiv.appendChild(newButtonHistory);var newButtonDelete=document.createElement('input');newButtonDelete.type='button';newButtonDelete.className='CancelButt';newButtonDelete.value='DELETE';newButtonDelete.onclick=function(){if(currentNote.ondelete)
{var res=currentNote.ondelete(currentNote);if(res)
{currentNote.container.DeleteNote(currentNote);}
else
{alert("error deleting note");}}
else
{alert("ondelete must be implemented in order to *actually* delete");}};if(this.permission>=2)
buttonsDiv.appendChild(newButtonDelete);editArea.appendChild(buttonsDiv);noteArea.appendChild(editArea);this.dragresize.isElement=function(elm)
{if(elm.className=='fn-area')
{this.maxRight=currentNote.container.element.offsetWidth-30;this.maxBottom=currentNote.container.element.offsetHeight-19;return true;}};this.dragresize.isHandle=function(elm)
{if(elm.className=='fn-area')
return true;};this.dragresize.ondragfocus=function()
{currentNote.gui.ElementRect.style.cursor='move';};this.dragresize.ondragblur=function()
{currentNote.gui.ElementRect.style.cursor='pointer';};this.dragresize.ondragstart=function()
{if(currentNote.oldRect==null)
{var r=currentNote.rect;currentNote.oldRect=new PhotoNoteRect(r.left,r.top,r.width,r.height);}};this.dragresize.ondragend=function()
{};this.dragresize.ondragmove=function()
{currentNote.rect.left=parseInt(this.element.style.left);currentNote.rect.top=parseInt(this.element.style.top);currentNote.rect.width=parseInt(this.element.style.width);currentNote.rect.height=parseInt(this.element.style.height);currentNote.PositionNote();};this.dragresize.apply(document);this.gui.ElementRect=newArea;this.gui.ElementNote=noteArea;this.gui.EditArea=editArea;this.gui.TextBox=newTextbox;this.gui.TextTitle=titleArea;this.gui.DeleteButton=newButtonDelete;this.PositionNote();}
PhotoNote.prototype.PositionNote=function()
{this.gui.ElementRect.style.left=this.rect.left+'px';this.gui.ElementRect.style.top=this.rect.top+'px';this.gui.ElementRect.style.width=this.rect.width+'px';this.gui.ElementRect.style.height=this.rect.height+'px';this.gui.ElementRect.firstChild.style.width=parseInt(this.gui.ElementRect.style.width)-2+'px';this.gui.ElementRect.firstChild.style.height=parseInt(this.gui.ElementRect.style.height)-2+'px';this.gui.ElementRect.firstChild.firstChild.style.width=parseInt(this.gui.ElementRect.style.width)-4+'px';this.gui.ElementRect.firstChild.firstChild.style.height=parseInt(this.gui.ElementRect.style.height)-4+'px';this.gui.ElementRect.firstChild.firstChild.firstChild.style.width=parseInt(this.gui.ElementRect.style.width)-6+'px';this.gui.ElementRect.firstChild.firstChild.firstChild.style.height=parseInt(this.gui.ElementRect.style.height)-6+'px';this.gui.ElementNote.style.left=this.rect.left+this.XOffset+'px';this.gui.ElementNote.style.top=this.rect.top+this.YOffset+this.rect.height+'px';}
function PhotoNoteGUI()
{this.ElementRect=null;this.ElementNote=null;this.TextTitle=null;this.EditArea=null;this.TextBox=null;this.DeleteButton=null;}
function PhotoNoteRect(left,top,width,height)
{this.left=left;this.top=top;this.width=width;this.height=height;}
PhotoNoteRect.prototype.toString=function()
{return'left: '+this.left+', top: '+this.top+', width: '+this.width+', height: '+this.height;}
var aeOL=[];function addEvent(o,n,f,l)
{var a='addEventListener',h='on'+n,b='',s='';if(o[a]&&!l)return o[a](n,f,false);o._c|=0;if(o[h])
{b='_f'+o._c++;o[b]=o[h];}
s='_f'+o._c++;o[s]=f;o[h]=function(e)
{e=e||window.event;var r=true;if(b)r=o[b](e)!=false&&r;r=o[s](e)!=false&&r;return r;};aeOL[aeOL.length]={o:o,h:h};};addEvent(window,'unload',function(){for(var i=0;i<aeOL.length;i++)with(aeOL[i])
{o[h]=null;for(var c=0;o['_f'+c];c++)o['_f'+c]=null;}});function cancelEvent(e,c)
{e.returnValue=false;if(e.preventDefault)e.preventDefault();if(c)
{e.cancelBubble=true;if(e.stopPropagation)e.stopPropagation();}};function addLoadEvent(func){var oldonload=window.onload;if(typeof window.onload!='function'){window.onload=func;}else{window.onload=function(){oldonload();func();}}}
Array.prototype.clear=function(){this.length=0;};Array.prototype.remove=function(element){var result=false;var array=[];for(var i=0;i<this.length;i++){if(this[i]==element){result=true;}else{array.push(this[i]);}}
this.clear();for(var i=0;i<array.length;i++){this.push(array[i]);}
array=null;return result;};function DragResize(myName,config)
{var props={myName:myName,enabled:true,handles:['tl','tm','tr','ml','mr','bl','bm','br'],isElement:null,isHandle:null,element:null,dragging:null,minWidth:10,minHeight:10,minLeft:0,maxRight:9999,minTop:0,maxBottom:9999,zIndex:1,mouseX:0,mouseY:0,lastMouseX:0,lastMouseY:0,mOffX:0,mOffY:0,elmX:0,elmY:0,elmW:0,elmH:0,allowBlur:true,ondragfocus:null,ondragstart:null,ondragmove:null,ondragend:null,ondragblur:null};for(var p in props)
{this[p]=(typeof config[p]=='undefined')?props[p]:config[p];}};DragResize.prototype.apply=function(node)
{var obj=this;addEvent(node,'mousedown',function(e){obj.mouseDown(e)});addEvent(node,'mousemove',function(e){obj.mouseMove(e)});addEvent(node,'mouseup',function(e){obj.mouseUp(e)});};DragResize.prototype.handleSet=function(elm,show){with(this)
{if(!elm._handle_tr)
{for(var h=0;h<handles.length;h++)
{var hDiv=document.createElement('div');hDiv.className=myName+' '+myName+'-'+handles[h];elm['_handle_'+handles[h]]=elm.appendChild(hDiv);}}
for(var h=0;h<handles.length;h++)
{elm['_handle_'+handles[h]].style.visibility=show?'inherit':'hidden';}}};DragResize.prototype.select=function(newElement){with(this)
{if(!document.getElementById||!enabled)return;if(newElement&&(newElement!=element)&&enabled)
{element=newElement;element.style.zIndex=++zIndex;handleSet(element,true);elmX=parseInt(element.style.left);elmY=parseInt(element.style.top);elmW=element.offsetWidth;elmH=element.offsetHeight;if(ondragfocus)this.ondragfocus();}}};DragResize.prototype.deselect=function(keepHandles){with(this)
{if(!document.getElementById||!enabled)return;if(!keepHandles)
{if(ondragblur)this.ondragblur();handleSet(element,false);element=null;}
dragging=null;mOffX=0;mOffY=0;}};DragResize.prototype.mouseDown=function(e){with(this)
{if(!document.getElementById||!enabled)return true;var elm=e.target||e.srcElement,newElement=null,newHandle=null,hRE=new RegExp(myName+'-([trmbl]{2})','');while(elm)
{if(elm.className)
{if(!newHandle&&(hRE.test(elm.className)||isHandle(elm)))newHandle=elm;if(isElement(elm)){newElement=elm;break}}
elm=elm.parentNode;}
if(element&&(element!=newElement)&&allowBlur)deselect(false);if(newElement&&(!element||(newElement==element)))
{cancelEvent(e);select(newElement,newHandle);dragging=newHandle;if(dragging&&ondragstart)this.ondragstart();}}};DragResize.prototype.mouseMove=function(e){with(this)
{if(!document.getElementById||!enabled)return true;mouseX=e.pageX||e.clientX+document.documentElement.scrollLeft;mouseY=e.pageY||e.clientY+document.documentElement.scrollTop;var diffX=mouseX-lastMouseX+mOffX;var diffY=mouseY-lastMouseY+mOffY;mOffX=mOffY=0;lastMouseX=mouseX;lastMouseY=mouseY;if(!dragging)return true;var hClass=dragging&&dragging.className&&dragging.className.match(new RegExp(myName+'-([tmblr]{2})'))?RegExp.$1:'';var rs=0,dY=diffY,dX=diffX;if(hClass.indexOf('t')>=0)
{rs=1;if(elmH-dY<minHeight)mOffY=(dY-(diffY=elmH-minHeight));else if(elmY+dY<minTop)mOffY=(dY-(diffY=minTop-elmY));elmY+=diffY;elmH-=diffY;}
if(hClass.indexOf('b')>=0)
{rs=1;if(elmH+dY<minHeight)mOffY=(dY-(diffY=minHeight-elmH));else if(elmY+elmH+dY>maxBottom)mOffY=(dY-(diffY=maxBottom-elmY-elmH));elmH+=diffY;}
if(hClass.indexOf('l')>=0)
{rs=1;if(elmW-dX<minWidth)mOffX=(dX-(diffX=elmW-minWidth));else if(elmX+dX<minLeft)mOffX=(dX-(diffX=minLeft-elmX));elmX+=diffX;elmW-=diffX;}
if(hClass.indexOf('r')>=0)
{rs=1;if(elmW+dX<minWidth)mOffX=(dX-(diffX=minWidth-elmW));else if(elmX+elmW+dX>maxRight)mOffX=(dX-(diffX=maxRight-elmX-elmW));elmW+=diffX;window.status='diffX:'+diffX;}
if(dragging&&!rs)
{if(elmX+dX<minLeft)mOffX=(dX-(diffX=minLeft-elmX));else if(elmX+elmW+dX>maxRight)mOffX=(dX-(diffX=maxRight-elmX-elmW));if(elmY+dY<minTop)mOffY=(dY-(diffY=minTop-elmY));else if(elmY+elmH+dY>maxBottom)mOffY=(dY-(diffY=maxBottom-elmY-elmH));elmX+=diffX;elmY+=diffY;}
with(element.style)
{left=elmX+'px';width=elmW+'px';top=elmY+'px';height=elmH+'px';}
if(window.opera&&document.documentElement)
{var oDF=document.getElementById('op-drag-fix');if(!oDF)
{var oDF=document.createElement('input');oDF.id='op-drag-fix';oDF.style.display='none';document.body.appendChild(oDF);}
oDF.focus();}
if(ondragmove)this.ondragmove();cancelEvent(e);}};DragResize.prototype.mouseUp=function(e){with(this)
{if(!document.getElementById||!enabled)return;if(ondragend)this.ondragend();deselect(true);}};